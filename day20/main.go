package main

import (
	"fmt"
	"strings"
)

func main() {
	part1()
	part2()
}

func part1() {
	portals := map[[2]int][2]int{}
	var start [2]int
	var end [2]int

	lines := strings.Split(input, "\n")

	dirs := [][2]int{{1, 0}, {0, 1}, {-1, 0}, {0, -1}}
	fwddir := []bool{true, true, false, false}

	valid := func(p [2]int) bool {
		return p[0] >= 0 && p[0] < len(lines) && p[1] >= 0 && p[1] < len(lines[p[0]])
	}

	tempPortals := map[[2]byte][2]int{}

	for i, line := range lines {
		for j := 0; j < len(line); j++ {
			if lines[i][j] != '.' {
				continue
			}
			p := [2]int{i, j}
			for k, dir := range dirs {
				fwd := fwddir[k]

				p1 := [2]int{i + dir[0], j + dir[1]}
				p2 := [2]int{i + dir[0]*2, j + dir[1]*2}
				if !valid(p1) || !valid(p2) {
					continue
				}

				c1 := lines[p1[0]][p1[1]]
				c2 := lines[p2[0]][p2[1]]

				if c1 < 'A' || c1 > 'Z' || c2 < 'A' || c2 > 'Z' {
					continue
				}

				var label [2]byte
				if fwd {
					label = [2]byte{c1, c2}
				} else {
					label = [2]byte{c2, c1}
				}

				if label == [2]byte{'A', 'A'} {
					start = p
					continue
				}
				if label == [2]byte{'Z', 'Z'} {
					end = p
					continue
				}

				if ex, ok := tempPortals[label]; ok {
					portals[ex] = p
					portals[p] = ex
					delete(tempPortals, label)
				} else {
					tempPortals[label] = p
				}
			}
		}
	}

	seen := map[[2]int]bool{}
	work := [][3]int{{start[0], start[1], 0}}
	for len(work) > 0 {
		w := work[0]
		work = work[1:]
		key := [2]int{w[0], w[1]}

		if key == end {
			fmt.Println(w[2])
			return
		}
		if seen[key] {
			continue
		}
		seen[key] = true

		for _, dir := range dirs {
			w2 := [3]int{w[0] + dir[0], w[1] + dir[1], w[2] + 1}
			k2 := [2]int{w2[0], w2[1]}
			if !valid(k2) {
				continue
			}
			if lines[k2[0]][k2[1]] != '.' {
				continue
			}
			work = append(work, w2)
		}
		if jump, ok := portals[key]; ok {
			work = append(work, [3]int{jump[0], jump[1], w[2] + 1})
		}
	}
}

func part2() {
	portals := map[[2]int][2]int{}
	var start [2]int
	var end [2]int

	lines := strings.Split(input, "\n")

	dirs := [][2]int{{1, 0}, {0, 1}, {-1, 0}, {0, -1}}
	fwddir := []bool{true, true, false, false}

	valid := func(p [2]int) bool {
		return p[0] >= 0 && p[0] < len(lines) && p[1] >= 0 && p[1] < len(lines[p[0]])
	}

	tempPortals := map[[2]byte][2]int{}

	isInner := func(p [2]int) bool {
		return p[0] > 10 && p[0] < len(lines)-10 && p[1] > 10 && p[1] < len(lines[4])-10
	}

	for i, line := range lines {
		for j := 0; j < len(line); j++ {
			if lines[i][j] != '.' {
				continue
			}
			p := [2]int{i, j}
			for k, dir := range dirs {
				fwd := fwddir[k]

				p1 := [2]int{i + dir[0], j + dir[1]}
				p2 := [2]int{i + dir[0]*2, j + dir[1]*2}
				if !valid(p1) || !valid(p2) {
					continue
				}

				c1 := lines[p1[0]][p1[1]]
				c2 := lines[p2[0]][p2[1]]

				if c1 < 'A' || c1 > 'Z' || c2 < 'A' || c2 > 'Z' {
					continue
				}

				var label [2]byte
				if fwd {
					label = [2]byte{c1, c2}
				} else {
					label = [2]byte{c2, c1}
				}

				if label == [2]byte{'A', 'A'} {
					start = p
					continue
				}
				if label == [2]byte{'Z', 'Z'} {
					end = p
					continue
				}

				if ex, ok := tempPortals[label]; ok {
					portals[ex] = p
					portals[p] = ex
					delete(tempPortals, label)
				} else {
					tempPortals[label] = p
				}
			}
		}
	}

	endl := [3]int{end[0], end[1], 0}
	seen := map[[3]int]bool{}
	work := [][4]int{{start[0], start[1], 0, 0}}
	for len(work) > 0 {
		w := work[0]
		work = work[1:]
		key := [3]int{w[0], w[1], w[2]}

		if key == endl {
			fmt.Println(w[3])
			return
		}
		if seen[key] {
			continue
		}
		seen[key] = true

		for _, dir := range dirs {
			w2 := [4]int{w[0] + dir[0], w[1] + dir[1], w[2], w[3] + 1}
			k2 := [2]int{w2[0], w2[1]}
			if !valid(k2) {
				continue
			}
			if lines[k2[0]][k2[1]] != '.' {
				continue
			}
			work = append(work, w2)
		}
		wp := [2]int{w[0], w[1]}
		if jump, ok := portals[wp]; ok && w[2] > 0 || isInner(wp) {
			off := -1
			if isInner(wp) {
				off = 1
			}
			work = append(work, [4]int{jump[0], jump[1], w[2] + off, w[3] + 1})
		}
	}
}

const input = `                                       U         R     Q     F           T C   J
                                       S         E     V     C           Q G   C
  #####################################.#########.#####.#####.###########.#.###.#######################################
  #...#...................#.........#.......#.....#.#...#...#.#...#.......#.#...#...#.#.........#.#.#.....#...#...#.#.#
  #.#.###.#.###.#.#######.###.###.#.###.#####.#.###.#.###.#.#.#.#####.###.#.#.#.#.###.#.#########.#.#.#.###.###.###.#.#
  #.#...#.#...#.#.#...#.......#...#...#.#.#...#...#.......#.#.....#...#.....#.#...#.................#.#.#.#.#...#.....#
  #####.#########.###.###.#####.###.#.#.#.###.#############.###.###.#.#####.#.#.###.#####.#.#.###.#####.#.#.###.###.###
  #.......#.........#.....#.#...#...#.......#.....#.#.....#.#...#.#.#.....#.#.#.....#.#...#.#.#.#.#.....#.....#.#.....#
  #####.#.###.###.###.#.###.###.#.###.#.#.#####.#.#.###.#.#.#.###.###.#######.#.#####.#.#.#####.#.#####.###.###.#.#.#.#
  #.#...#.#.#.#.#.#...#.#.....#.#.#...#.#...#...#...#...#...#.......#...#.#.#.#.#.....#.#.......#.#.......#.#.....#.#.#
  #.###.###.###.#.#####.#.###.#########.#.#.###.#.#.#.###.#####.#.#####.#.#.#.###.#####.###.###.#####.#.#.#.###.#######
  #...#.........#.#.#...#.#...........#.#.#.#...#.#.#.#...#.#...#.....#.....#...#.#.#.#.#.#...#.#.#...#.#...#.#...#...#
  ###.###.#####.###.###########.#.###.###.#########.#.#####.###.#########.###.###.#.#.#.#.#######.#######.###.#.###.#.#
  #.......#.#.#.........#.#.#...#...#...#.......#.#.#.#.#...........#.....#.........#...#.....#.#...#.#...#.......#.#.#
  #####.#.#.#.#.###.###.#.#.#.#######.#.#.#.#.###.#.#.#.###.###.#######.#####.#.#########.#####.#.###.#.#####.###.###.#
  #.#...#.#...#.#...#.#...#.......#...#...#.#.#.....#.....#.#.......#.#...#.#.#...............#...#.#...#.......#...#.#
  #.#########.#######.###.###########.###.#########.#.#.#.#########.#.#.###.#.#.#####.#.#.#####.###.#.#.#.#.#########.#
  #.......#.#...#.#.....#.#.#...#.....#.....#.......#.#.#.#...#.....#.....#...#.#.#...#.#.#.......#.#.#.#.#...#.#.#.#.#
  ###.#####.###.#.#####.#.#.###.#####.###.#.#####.#.#.#######.#.#.#.###.#####.#.#.###.#####.###.#.#.###.###.###.#.#.#.#
  #...#...#.#.#.#.#.#.#...#.#.......#...#.#.#.....#.#.....#.....#.#.#.......#.#.....#.#.#.#...#.#.#.....#.#.#.....#.#.#
  ###.#.###.#.#.#.#.#.#.###.###.#.#.#.#.#######.###.###.#.#.#.#######.###.#####.#####.#.#.#.#.#########.#.#.###.###.#.#
  #.....#.#.......#...#.#.#.#...#.#...#.#...#...#.#.#...#.#.#.#.#...#.#.#.#.#...#.#.#.#...#.#.#.#.......#.#...........#
  ###.###.#######.###.#.#.#.#####.#.#.#####.#####.#.#.#######.#.###.#.#.###.#.###.#.###.###.###.###.###.#.#.#########.#
  #...#...#.#.#.............#...#.#.#.#.#...#.#.#.#.#.......#.......#.......#...#.........#...#.#.#.#...............#.#
  ###.###.#.#.#######.#.#.#.###.#####.#.#.###.#.#.#.#######.###.###.#######.#.#####.#######.###.#.#.#######.#.#########
  #...#...#.....#.#...#.#.#.#...#...#.....#...#.....#.........#.#...#.....#.#.....#...#.#.#.......#.#.......#.........#
  #.#.###.###.###.#########.###.#.#######.#.#######.#.#########.###.#.#.###.#.#####.###.#.###.#########.#.#.#########.#
  #.#.#...........#.#...#.#...#.........#...#.#.....#.#.....#.#.#...#.#.....#.#.................#.#.#.#.#.#.....#.#.#.#
  ###.###.#.#.#####.###.#.###.###.###.#.###.#.#.#####.#.###.#.#####.#.#######.#.###.#####.#######.#.#.#.###.#####.#.###
  #...#.#.#.#...#.#.#.#...........#...#.....#...#...#...#.#.....#...#.......#...#.......#.....#...#...#.#.#.........#.#
  #.#.#.###.#####.#.#.#####.#.#.#####.#####.#.#####.#####.#.#.#####.#######.#####.###.#######.###.#.#####.#.#########.#
  #.#.#.#...#.#...#...#.#...#.#.#.#.....#.#.#.........#.#...#.....#.#.........#.....#.......#.#...#...#.#.#.........#.#
  #.###.###.#.###.#.###.#########.###.#.#.#########.###.#.#.#.#.###.###.#########.###.#.#.#######.#.###.#.#.#########.#
  #...#...#.#.#...#.....#.#.....#...#.#.....#.......#.....#.#.#.#...#.......#.......#.#.#...#.#...#...#.#.#...#.#.....#
  #.###.#.#.#.#.###.#.###.#####.#.#########.#.#######.###########.###.###.#####.#######.#.###.#.#.###.#.#.#.###.###.###
  #.#.#.#...#.#...#.#.......#.#.#.#        B J       D           B   E   B     O      #.#.#...#.#.#.#.#.#...#.#.#.....#
  #.#.###.#.#.###.#####.#.###.#.#.#        M B       Z           Z   P   C     K      #####.#.###.#.#.#.###.#.#.###.###
  #...#.#.#.....#.#.#.#.#.#.#.#...#                                                   #...#.#.....#...........#.....#.#
  #.###.###.#####.#.#.###.#.#.#.#.#                                                   #.#####.###.#.#####.###.#.###.#.#
  #.....#...#.#.....#...#.......#.#                                                   #.......#...#.#.#.....#...#......MZ
  #####.#.#.#.###.###.#######.###.#                                                   ###.#.###.###.#.###.###.#.###.#.#
ZR......#.#...#.........#.....#....FC                                               HM..#.#.#.#...#...#.#...#.#.#...#.#
  #.###.###.#.#.#######.###.#####.#                                                   #.#.###.###.#.###.#.#.#########.#
  #.#.......#.....#.........#...#.#                                                   #...#.#.#.#.....#.#.#...#.....#.#
  #.###.#.#####################.###                                                   #####.#.#.#######.#####.#####.###
  #.#...#.#.....#...#.#.#.......#.#                                                   #.#...........#...#...#.#........ZZ
  #########.#.#.###.#.#.###.###.#.#                                                   #.#.#.#####.#####.###.###.#######
  #.#.......#.#.#.#.#.......#.#...#                                                   #...#...#...#.#.#...#.#.........#
  #.###.#####.###.#.#.#.#####.###.#                                                   #.###.###.###.#.#.#.#.#########.#
  #...#.....#.#.....#.#.#.........#                                                 QV..#...#.......#.#.#...#.#.....#..BZ
  #.#######.#.###.#.#.#####.#######                                                   #.#########.###.#.###.#.#.###.#.#
HM..........#.....#.......#........TQ                                                 #...#.#.#.........#.#.....#.....#
  #.#.#############################                                                   #####.#.###########.#####.#.#####
  #.#.#.#.......#...........#.....#                                                   #.................#.....#.#.#.#..OK
  #####.#####.#.#.#.###.###.###.#.#                                                   #.#.#.###.###.#.#.#.#########.#.#
AA..#.....#.#.#...#...#...#.#...#.#                                                 US..#.#...#.#...#.#.....#.....#...#
  #.#.#####.#.#############.#.#.#.#                                                   #.###.#######.#.#####.#.###.#.###
EK....#.....#...#.......#.#.#.#.#..UG                                                 #.#.#.#.#.....#.#.....#.#...#...#
  ###.###.#.#.#####.#####.#.#.###.#                                                   #.#.###.###########.###.#.#####.#
  #.......#...#...#.....#.....#...#                                                   #.#.....#...#.#.#.......#.......#
  #.#############.#.###############                                                   #####.###.###.#.#################
  #.#...........................#.#                                                   #...................#............II
  ###.###.#.#.#.###.#.#######.###.#                                                   #.#.#####.#########.#.###.#.###.#
  #.#...#.#.#.#.#.#.#.#.........#.#                                                 SJ..#...#.....#...#.#...#...#...#.#
  #.#.#####.#####.#.#########.###.#                                                   #############.###.#####.#########
UG......#.....#...#.#...#...#.#....QM                                               KI..............#.......#...#.#...#
  #.#.#.#.#####.#####.#####.#.#.###                                                   #.###.###.###.#.#####.#.###.###.#
  #.#.#.#.#...#...#.....#...#.....#                                                   #.#.....#.#.....#.....#.#.....#.#
  #########.###.###.#####.#######.#                                                   #.###.###.###.###.#########.#.#.#
  #.#.......#...................#.#                                                   #.#.#.#...#.....#.#...#.....#....EP
  #.#####.#.#.#####.#.#.#.#.###.###                                                   #.#.###.###.#####.#.#.#####.#.#.#
  #.......#.#...#...#.#.#.#.#.#...#                                                   #.....#...#...#.....#.......#.#.#
  #.#.#####.#.###.###.###.###.#.###                                                   #.#.#.###########.#######.#######
  #.#...#.#.#...#.#...#...#........NU                                                 #.#.#.#.#.....#.#.#.....#.#...#.#
  #####.#.#.#.#########.#.#####.###                                                   #######.#####.#.###.###.###.#.#.#
BC......#.......#...#.#.#.#...#...#                                                   #...#...#.#.....#.....#.....#....KI
  ###############.###.#####.#.###.#                                                   ###.###.#.#.#.#.#####.#####.###.#
  #...........#...........#.#.#.#.#                                                   #.#.#.#.#...#.#.#.......#...#...#
  #.#######.#.#.###.#.#####.###.#.#                                                   #.#.#.#.#.#.#.###.###.#######.###
  #.......#.#...#.#.#.....#...#.#.#                                                 ZC..........#.#.......#.#...#...#.#
  #.###.#####.#.#.###.#####.###.###                                                   #.###.#.#.#####.#####.###.#####.#
  #...#...#.#.#...#.......#.#...#..RK                                                 #...#.#.#.#.#.......#.#.....#....SJ
  #.#######.#.#.#######.###.###.#.#                                                   #########.#.###.#.#.#####.#.###.#
ZC....#...#.#.#...#.#.#...........#                                                 JC....#.#.#.#...#.#.#.#.#.#.#...#.#
  #######.#.#######.#.###.###.#####                                                   #.#.#.#.###.#########.#.#.###.#.#
NU......#...#...#...#...#.#.#.#.#..RE                                                 #.#...#.......#...#.#.#...#...#.#
  #.#####.###.#.#.#.#.#.###.###.#.#                                                   ###.#######.#.#.###.#.#.###.###.#
  #...........#...#...#...........#                                                   #...........#.............#.....#
  #.#.###.#.###.#####.#####.#.#.###      W         E     Z   C         I     M        ###.#.#.#.#.###.###.###.#.#.###.#
  #.#.#.#.#...#...#...#.....#.#...#      Z         K     R   G         I     Z        #...#.#.#.#.#...#...#...#.#.#...#
  ###.#.###.#####.###.#.###.#.#.#.#######.#########.#####.###.#########.#####.#########.#.#.#.#.#############.###.#####
  #.....#.#.#.#.#.#...#.#...#.#.#...#.#.#.#.#.......#.#.#...#.......#.....#...........#.#.#.#.#.....#.........#.......#
  ###.#.#.#.#.#.#####.#####.#.#######.#.#.#.#.#######.#.###.###.#####.#.#.###.#####.#####.#####.#.#####.###.#.#####.###
  #...#.#.........#...#.#...#.#.#.#.#...#...#.......#.....#...#...#...#.#.#.#.#.#.....#.....#...#.#.#...#...#.....#...#
  #.#.###.###.###.#.#.#.#####.#.#.#.###.###.#######.#.###.#.#####.###.#####.###.#.#############.#.#.#######.#.#.#.###.#
  #.#.#...#.....#.#.#.....#...#.....#.#.........#...#...#.....#...#.....#...#.#.......#...#...#.#.#.#.#.....#.#.#...#.#
  #.#####.###.#.###.###.###########.#.#.#####.#####.#.#####.###.#####.#####.#.#####.###.###.#######.#.#####.#####.#####
  #.#.....#...#.#.#.#.#.#.#.................#.#.#...#.#.#.....#.....#.....#.#.....#.......#.....#...#...#...#.......#.#
  #.###.#.#.#.###.###.#.#.#####.###.###.#######.#.#.#.#.#.###.#.#.#.#.#.###.#.###.#.#.#.###.#######.#.###.#.#.#.#.###.#
  #.#.#.#.#.#.....#.......#.......#.#...#.#.#.....#.#...#.#.#.#.#.#.#.#.#.......#...#.#.......#.........#.#.#.#.#.....#
  #.#.#########.#.###.#.#####.###.#.###.#.#.#.#.###.#.#####.#######.#.###.#.#.#.#######.#######.#####.#####.###.#.#.#.#
  #.........#...#.#...#.#.......#.#...#.#...#.#.#...#.....#.........#...#.#.#.#.....#...............#...#.....#.#.#.#.#
  #.#############.###.###.#.#######.###.#.#.#######.#.###.#####.###.#.#############.###.#.#####.#.###.#.#.#####.###.#.#
  #.....#...#.#...#.#.#.#.#.#.#.#.#.#.....#.#.#.....#...#.#.......#.#...#...#.....#...#.#.....#.#.#...#.#.#.#.....#.#.#
  #.###.#.###.#####.###.#####.#.#.#.###.#####.###.###.#####.#.###.###.#####.#.###.#.###########.###.#.###.#.###.#######
  #.#.#.....#.........#.#.........#.#...#.#...#.#.#.#.#...#.#...#...#.#.#.....#.#.......#.....#...#.#...#.....#.......#
  #.#.#.#####.#.#.###.#.#####.#.#.#.###.#.###.#.#.#.#.###.###.#####.#.#.#####.#######.###.###.#####.#.###.#######.###.#
  #...#...#...#.#.#.#.....#...#.#.#.#.....#.........#.......#.#...#.#...#.#.......#.#.......#.....#.#...#.#...#.....#.#
  #.#.#.#####.#####.#.#.#####.###.#######.###.#.###.#######.#####.#.###.#.###.#####.###.#.#############.###.###.###.#.#
  #.#.#.....#...#.....#.....#.#...#...#...#.#.#.#.#...#.......#.#...#.#.#...#.........#.#.....#.#.............#.#.#.#.#
  #.#.###.#########.#######.#####.###.###.#.#.###.#####.###.#.#.#.###.#.#.#.###.#.###.#.#.#.#.#.#.###.#####.#.#.#.#.###
  #.#.#...#.........#.#...................#.......#.......#.#.#...#.#...#.#.#...#...#.#.#.#.#.#...#.......#.#.#.#.....#
  #.#####.#####.###.#.###.###.###.#.###.###.#.###.#######.#.#####.#.#.###.#.#.###.#########.#######.###.#######.###.#.#
  #.#.....#.#...#.#.#.....#...#...#.#.....#.#...#.#.......#.#.......#...#.#.#...#.......#.#.....#.....#.#.#.#.....#.#.#
  #####.###.#.###.#.#.#.#.###.###.#.###.#####.#####.###.###########.#.#.#.#.#.###.###.#.#.#########.###.#.#.###.###.###
  #.......#...#.....#.#.#.#...#...#.#.#.#.#.....#.#.#.....#.......#.#.#...#.#...#.#...#.#.#.#...#.#.#...#...#.....#.#.#
  #.#######.###.###.#######.#####.#.#.#.#.#.###.#.#####.#.#.#######.#######.#.###########.#.###.#.###.###.#########.#.#
  #.#.....#.#.....#...#.#...#...#.#.#.....#.#.......#.#.#.....#...#.#.....#.#.....#...............#.......#.#...#.#...#
  #######.###.#########.###.#.#.#####.#.#####.###.#.#.#####.###.###.#.###.#.#.#####.#.#####.#.###.#########.#.###.#.#.#
  #.............#.......#...#.#.....#.#.#.#.....#.#.#.......#.......#...#.#.#...#.#.#.#.#...#.#.....#.#...........#.#.#
  #.#####.#####.###.###.###########.###.#.###.#.###.###.###.#.#######.#.#.#.#.###.#.###.###.#.#######.#.###.#.#.#####.#
  #...#.....#...#.....#.....................#.#...#.#.....#.#.......#.#.#...#.............#.#.............#.#.#.....#.#
  #######################################.#######.#######.#########.###.#######.#######################################
                                         B       J       R         Q   D       W
                                         M       B       K         M   Z       Z                                         `
